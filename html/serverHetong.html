<!doctype html>
<!--
	编辑者：宋亚男
	合同申领和合同订单模块
-->
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/syn.css"/>
		<link rel="stylesheet" type="text/css" href="../css/reset.css"/>
		<link rel="stylesheet" type="text/css" href="../css/loadingSyn.css"/>
		<style type="text/css">
			.height-300{
				height: 150px;
			}
			
			.item-dingdan{
				margin-bottom: 9px;
				
				background: white;
			}
			
			.item-dingdan-title{
				margin-top: 10px;
			}
			.item-dingdan-number{
				margin-top: 14px;
			}
			.item-dingdan-button{
				background: #fbaf37;
				text-align: center;
				line-height: 27px;
				color: white;
				border-radius: 27px;
				float: right;
				width: 84px;
				height: 27px;
				font-family: "微软雅黑";
			}
			.item-dingdan-date{
				margin-top: 12px;
			}
			.item-dingdan-post{
				margin-top: 10px;
			}
			.item-dingdan-isAgree{
				font-size: 14px;
				font-family: "微软雅黑";
				color: #666666;
				margin-left: 24px;
				overflow: hidden;
			}
			.item-dingdan-img{
				vertical-align: middle;
			}
			
			.item-shenling{
				position: absolute;
				
				width: 100%;
				background: white;
				margin-bottom: 0px;
			}
			.item-shenling-ul{
				background: white;
				height: 615px;
				padding: 24px 24px 0 24px;
			}
			.item-shenling-li{
				overflow: hidden;
				line-height: 38px;
				margin-bottom: 9px;
			}
			.item-shenling-li>input{
				width: 62.7%;
				height: 36px;
				padding: 0 0 0 12px;
				margin-bottom: 0px;
				float: right;
				font-family: "微软雅黑";
				font-size: 14px;
				color: gray;
				margin-left: 5.3%;
			}
			.item-shenling-li>label{
				font-family: "微软雅黑";
				font-size: 14px;
				color: #333333;
				/*font-weight: bold;*/
			}
			.item-shenling-li textarea{
				border: 0.5px solid rgba(0,0,0,.2);
				font-size: 14px;
				font-family: "微软雅黑";
				color: gray;
				line-height: 21px;
				width: 62.7%;
				float: right;
				height: 72px;
				padding: 7.5px 0 0 12px;
				
			}
			.item-shenling-btn{
				font-family: "微软雅黑";
				font-size: 16px;
				color: white;
				height: 39px;
				width: 83%;
				margin-left: 8.5%;
				margin-top: 15px;
				font-weight: bold;
				margin-right: 8px;
				background: #fabf37;
				border-radius: 5px;
				text-align: center;
				line-height: 39px;
			}
			.item-back-img{
				display: inline-block;
				height: 18px;
				width: 9px;
				float: left;
			}
			.mui-slider-progress-bar{
				background:none !important;
			}
			.mui-active{
				
				border-bottom:2px solid #fbaf37 !important;
				
			}
			.mui-slider-item{
				border: none !important;
			}
			.imgBack{
				position: fixed;
				left: 10px;
				top: 6px;
				width: 9px;
				height: 16px;
				z-index: 4;
				color: black;
			}
			.mui-active{
				color: #FBAF37 !important;
			}
			.hiddenLi{
				overflow: hidden;
				padding: 0 24px;
			}
			.topbarTip{
				color: #333333;
				font-size: 14px;
			}
		</style>
	</head>

	<body style="overflow: hidden;">
		<!--加载页面-->
		<div 	id="loadPage"  class=" main">
			<div class="loadEffect">
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
			</div>
		</div>
		
		<a href="serverSalesmanJob.html" class="imgBack  mui-icon mui-icon-left-nav " ></a>
		
		
		<div style="height: 667px;" class="back-white   ">
	    	<div style="text-align: center;line-height: 42px; height: 42px; width: 100%; background: white; position: fixed;top: 0px;" class="">
		        <div id="item1Click" class="topbarTip" style="color: #FBAF37;border-bottom: solid 5px #FBAF37;  height: 42px;line-height: 42px; display: inline-block;">合同申领</div>
		        <div id="item2Click" class="topbarTip" style="margin-left: 20%;  height: 42px;line-height: 42px; display: inline-block;">合同订单</div>
		    </div>
		    
		    <div id="sliderProgressBar" style="width: 50%;height: 2px;" class="mui-slider-progress-bar mui-col-xs-4"></div>
		    <div class="" style="width: 100%;  position: fixed; top: 40px;">
		        <div id="item1" class="item-shenling " style="width: 100%;  height: 565px;overflow: hidden;">
		            <ul class="item-shenling-ul" style="border-top: solid 10px #f5f5f5;">
		            	<li>
		            		<div class="item-shenling-li">
		            		    <label>抵押合同:</label>
		            		    <input id="putDiya" style="" type="text" placeholder="">
		            		    
		            		</div>
		            	</li>
		            	<li>
		            		<div class="item-shenling-li">
		            		    <label>信用合同:</label>
		            		    <input  id="putXinyong" style="" type="text" placeholder="">
		            		</div>
		            	</li>
		            	<li>
		            		<div class="item-shenling-li">
		            		    <label>质押合同:</label>
		            		    <input id="putZhiya" style="" type="text" placeholder="">
		            		</div>
		            	</li>
		            	<li>
		            		<div class="item-shenling-li">
		            		    <label>申请原因:</label>
		            		    <textarea style="border: solid 1px #cccccc;" id="putReason" name="" rows=""  cols="" placeholder="简述你的原由......	"></textarea>
		            		</div>
		            	</li>
		            	<li style="text-align: center;position: ;">
		            		<div id="btnApply" class="item-shenling-btn">提交申请</div>
		            	</li>
		            	
		            </ul>
		        </div>
		        <div id="item2mobile" style="display: none; height: 500px;overflow: auto;"  class=" ">
		        	       
                	<ul id="htDingdan"class="item-dingdan mui-table-view" style=" overflow: auto;margin-bottom: 50px;">
                	       	<div id="htDingdanTips" style="display: none;  background: white;border-top: solid 10px #f5f5f5; color: #999999;text-align: center;">
                	       		<img style="width: 121px;height: 120px;margin-top: 75px;" src="../img/暂无数据.png" alt="" />
                	       		<div style="margin-top: 25px;">
			                		<span>暂无数据</span>
			                	</div>	
                	       	</div>
                	</ul>
			        
		        </div>
		    </div>
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/jquery-3.2.1.min.js"></script>
		<script src="../js/jquery.cookie.js"></script>
		<script src="../js/checkht.js"></script>
		<script type="text/javascript">
		
			var baseUrl=host+'/app/';
			var userid='';
			var numDiya='';
			var numXinyong='';
			var numZhiya='';
			var uuid= $.cookie('uuid');
			$('a').click(function(){
				if(checkYh($(this))){
					return true;
				}else{
					mui.alert('用户已经离线，请重新登录');
					return false;
				}
			})
			
			
			/*遮罩蒙版*/	
		 	var mask = mui.createMask(function () {
//					$('.modleChane').hide();
//					$('.modleWait').hide();
//					$('#msgResoult').hide();
					
				})
			/*获取本地userid*/
			var getUserid = function(){
				userid = $.cookie('uid');
				
//				userid='855614878264684544'
				console.log(userid)
			}
			/*切换合同申请和合同订单页面*/
			$('#item1Click').click(function(){
				if(checkYh($(this))){
					$('#item2mobile').hide();
				
					$('#item1').show();
					$('#item2Click').css({'color':'inherit','borderBottom':'none'});
					$('#item1Click').css({'color':'#fbaf37','borderBottom':'5px solid #fbaf37'})
					return true;
				}else{
					mui.alert('用户已经离线，请重新登录')
					return false;
				}
			})
			
			$('#item2Click').click(function(){
				if(checkYh($(this))){
					$('#item1').hide();
					$('#item2mobile').show();
					$('#item1Click').css({'color':'inherit','borderBottom':'none'});
					$('#item2Click').css({'color':'#fbaf37','borderBottom':'5px solid #fbaf37'})
					return true;
				}else{
					mui.alert('用户已经离线，请重新登录')
					return false;
				}
			})
			
			/*申请按钮恢复点击*/
			var btnDisplay=function(){
				$('#btnApply').css({'pointerEvents':'auto'});
			}
			/*合同申请请求*/
			var applyContract = function(dscount,zscount,xscount,rsason,id){
				mui.getJSON(baseUrl+'applycontract',{userid:userid,dcount:dscount,zcount:zscount,wcount:xscount,reason:rsason,printlogid:id,uuid:uuid},function(data){
							$('#htDingdan').unbind();
							$.each(data, function(infoindex,info) {
								if(info.code==500){
									mui.alert('用户已经离线，请重新登录')
								}else{
									mui.alert(info.message,'请求提交成功','确认',function(){
										document.getElementById("htDingdan").innerHTML = "";
										getHtDingdan();
										$('.main').hide();
										mask.close();		
										return;
									},'')
								}
								
							});
						}
					);
			}
			/*合同数量回显*/
			var getHtHuixian=function(){
				mui.getJSON(baseUrl+'availablecontract',{uname:'张',userid:userid},function(data){
						
						$.each(data, function(indexInfo,info) {
							var zhiyaNum=info.zcount;
							var diyaNum=info.dcount;
							var xinyongNum=info.wcount;
							if(zhiyaNum>5){
								zhiyaNum=5;
							}
							if(diyaNum>5){
								diyaNum=5;
							}
							if(xinyongNum>5){
								xinyongNum=5;
							}
							console.log(info);
							
							
							$('#putDiya').attr('placeholder','您最多可申请'+diyaNum+'份合同')
							$('#putXinyong').attr('placeholder','您最多可申请'+xinyongNum+'份合同');
							$('#putZhiya').attr('placeholder','您最多可申请'+zhiyaNum+'份合同');
							numDiya = info.dcount;
							numXinyong = info.wcount;
							numZhiya = info.zcount;
							
						});
					}
				);
				return numDiya+'&'+numXinyong+'&'+numZhiya;
			}
			/*合同订单回显*/
			var getHtDingdan= function(){
				var strHtml='';
				mui.getJSON(baseUrl+'getapplycontractlist',{uname:'张',userid:userid},function(data){
						
						$.each(data, function(indexInfo,info) {
							strHtml='';
							
							if(info.length==0){
								$('#htDingdanTips').show();
							}
							$.each(info,function(index,item){
								
								
		                		var status = item.applystatus;
//		                		console.log(item)
		                		if(status=='已驳回'){
		                			strHtml='<li id="itemLi" class="hiddenLi" style="border-top: solid 10px #f5f5f5; padding-bottom:10px" ><ul>'+
											
											'<li class="color-black font-size-16 font-family-black item-dingdan-title ">'+item.applytype+'</li>'+
						                		'<li class="item-dingdan-number">'+
						                			'<span class="color-black font-size-14 font-family-black ">申请数量:</span>'+
						                			'<span id="numApplyCount" class="color-gray" >'+item.applycount+'</span>'+
						                			'<div   class="float-right  display-inlineblock">'+
						                				'<div style="width: 2px;background: red;" class="center-line display-inlineblock"></div>'+
						                				'<img style="width: 17px;height: 17px; margin-bottom: 3px;" class="item-dingdan-img" src="../img/合同状态.png" />'+
						                				
						                				'<span id="statusSpan"  class="statusSpan  item-dingdan-isAgree">'+item.applystatus+'</span>'+
						                				
						                			'</div>'+
						                		'</li>'+
						                		'<li class="item-dingdan-date">'+
						                			'<span class="color-black font-size-14 font-family-black ">更新时间:</span>'+
						                			'<span class="color-gray font-size-14">'+item.applytime+'</span>'+
						                			'<span style="display: none;"   class="color-gray font-size-14">'+'&'+item.id+'&'+'</span>'+
						                		'</li>'+
						                		'<li style="margin-top: 4px;height:1px;background:#dadada" class=""></li>'+
						                		'<li id="btnPost"   class="btnPost item-dingdan-post">'+
						                			'<a href="javascript:;" class="item-dingdan-button   font-size-14 ">重新提交</a>'+
//						                			
						                		'</li>'+
						                		
						                	'</ul></li>';
						            $(strHtml).appendTo('#htDingdan'); 
						            	
		                		}else{
		                			var  urls = "../img/daishenheState.png";
		                			var colors = "color:#666666";
		                			if(status=='已同意'){
		                				urls="../img/tongyiSate.png";
		                				colors="color:#fbaf37";
		                			}
		                			strHtml='<li id="itemLi" class="hiddenLi" style="border-top: solid 10px #f5f5f5;" ><ul>'+
											
											'<li class="color-black font-size-16 font-family-black item-dingdan-title ">'+item.applytype+'</li>'+
						                		'<li class="item-dingdan-number">'+
						                			'<span class="color-black font-size-14 font-family-black ">申请数量:</span>'+
						                			'<span class="color-gray" >'+item.applycount+'</span>'+
						                			'<div   class="float-right display-inlineblock">'+
						                				'<div style="width: 2px;background: red;" class="center-line display-inlineblock"></div>'+
						                				'<img style="width: 17px;height: 17px; margin-bottom: 3px;" class="item-dingdan-img" src='+urls+' />'+
						                				
						                				'<span id="statusSpan"  style="'+colors+'"  class="statusSpan item-dingdan-isAgree">'+item.applystatus+'</span>'+
						                				
						                			'</div>'+
						                		'</li>'+
						                		'<li class="item-dingdan-date">'+
						                			'<span class="color-black font-size-14 font-family-black ">更新时间:</span>'+
						                			'<span class="color-gray font-size-14">'+item.applytime+'</span>'+
						                			
						                		'</li>'+
						                		
						                		'<li id="btnPost"   class="btnPost hiddenLi item-dingdan-post">'+
						                			
						                		'</li>'+
						                		
						                	'</ul></li>';
						            $(strHtml).appendTo('#htDingdan');      
		                		}
     										
							})
							 $('#htDingdan').on('click','a',function(){
							 	$('.main').show();
								mask.show();
						        var strInfo = $(this).parent().parent().parent().text();
//						        console.log(strInfo)
						        var strList = strInfo.split("申请数量:");
						        var strType=strList[0];
						        var strCount = strList[1].split('已驳回')[0];
						        var str = strList[1].split("已驳回")[1];
						        var strId = str.split('&')[1];
						        
						        var readyList = getHtHuixian();
						        var readyDiya= readyList.split("&")[0];
						        var readyXinyong = readyList.split("&")[1];
						        var readyZhiya = readyList.split("&")[2];
						        if(strType=='抵押贷'){
						        	if(strCount>readyDiya){
						        		mui.alert('已经超过合同最大份数限制');
						        		$('.main').hide();
										mask.close();
						        	}else{
						        		applyContract(strCount,0,0,'重新提交',strId);
						        	}						        	
						        }else if(strType=='质押贷'){
						        	if(strCount>readyZhiya){
						        		mui.alert('已经超过合同最大份数限制');
						        		$('.main').hide();
										mask.close();
						        	}else{
						        		applyContract(0,strCount,0,'重新提交',strId);
						        	}						        	
						        }else{
						        	if(strCount>readyXinyong){
						        		mui.alert('已经超过合同最大份数限制');
						        		$('.main').hide();
										mask.close();	
						        	}else{
						        		applyContract(0,0,strCount,'重新提交',strId);
						        	}
						        }
						     });
						});
						
					}
				);
			}
			
			mui.init({
				preloadPages:[
					
					getUserid(),
					getHtHuixian(),
					getHtDingdan(),
				]
			})
			/*提交申请单击事件*/
			var btnApply= document.getElementById('btnApply');
			btnApply.addEventListener('tap',function(){
				$('.main').show();
				mask.show();
				$('#btnApply').css({'pointerEvents':'none'})
				var textDiya=$('#putDiya').val();
				var textZhiya=$('#putZhiya').val();
				var textXinyong=$('#putXinyong').val();
				var textReason = $('#putReason').val();

				if(parseInt(textDiya)>parseInt(numDiya)||parseInt(textDiya)<=0){
					mui.alert('请输入正确的合同数量','提交失败','确认',btnDisplay(),'');
					$('.main').hide();
					mask.close();
					
				} else if(parseInt(textXinyong)>parseInt(numXinyong)||parseInt(textXinyong)<=0){
					mui.alert('请输入正确的合同数量','提交失败','确认',btnDisplay(),'');
					$('.main').hide();
					
					mask.close();
					
				}else if(parseInt(textZhiya)>parseInt(numZhiya)||parseInt(textZhiya)<=0){
					mui.alert('请输入正确的合同数量','提交失败','确认',btnDisplay(),'');
					$('.main').hide();
					mask.close();
					
					
				}else if(textDiya==''&&textXinyong==''&&textZhiya==''){
					mui.alert('请输入正确的合同数量','提交失败','确认',btnDisplay(),'')
					$('.main').hide();
					mask.close();
					
				}else{
					
					if(textDiya==''){
						textDiya=0;					
					} if(textReason==''){
						textReason='无';
					}if(textXinyong==''){
						textXinyong=0;
					}if(textZhiya==''){
						textZhiya=0;
					} 
					
					mui.getJSON(baseUrl+'applycontract',{userid:userid,dcount:textDiya,zcount:textZhiya,wcount:textXinyong,reason:textReason,uuid:uuid},function(data){
							console.log(data)

							$.each(data, function(infoindex,info) {
								console.log(info)
								if(info.code==500){
									mui.alert('用户已经离线，请重新登录',function(){
										btnDisplay();
										window.location.reload();
										$('.main').hide();
										mask.close();
									})
								}else{
									mui.alert(info.message,'请求提交成功','确认',function(){
										btnDisplay()
										window.location.reload();
										$('.main').hide();
										mask.close();
									},'')
								}
								
							});
						}
					);			
				}
				
				
				
			})
//			/*重新提交按钮*/
//			mui('.mui-table-view').on('tap','.item-dingdan-button',function(){
//			  	mui.alert('提交成功','合同订单','确认','','')		  	
//			}) 
			
		</script>
	</body>
</html>